<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Data Debug Page</title>
    <script src="data.js"></script>
    <script src="js/panzoom.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #222;
            color: #eee;
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: center;
            border-bottom: 2px solid #555;
            padding-bottom: 10px;
        }
        .debug-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }
        .debug-item {
            border: 2px solid #444;
            border-radius: 10px;
            padding: 15px;
            background-color: #333;
            width: 100%;
            max-width: 600px;
        }
        .debug-item h2 {
            margin-top: 0;
            text-align: center;
            color: #00aaff;
        }
        .debug-item .coords {
            font-family: monospace;
            font-size: 1.1em;
            color: #ffaa00;
        }
        .track-photo {
            width: 100%;
            height: auto;
            border-radius: 5px;
            aspect-ratio: 3 / 2;
            object-fit: contain;
            background-color: #000;
        }
        
        /* Styles for PanZoom functionality */
        .debug-map-wrapper {
            position: relative;
            margin-top: 15px;
            border: 1px solid #555;
            overflow: hidden;
            cursor: grab;
            background-color: #3E7BB6;
            aspect-ratio: 2004 / 1086;
        }
        .debug-map-wrapper.grabbing { cursor: grabbing; }
        .debug-map-container {
            position: relative;
            width: 2004px;
            height: 1086px;
            transform-origin: 0 0;
        }
        .map-image {
            display: block;
            width: 100%;
            height: 100%;
        }
        .marker {
            position: absolute;
            width: 24px;
            height: 24px;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 10;
        }
        .zoom-indicator-circle {
            position: absolute;
            width: 40px;
            height: 40px;
            border: 5px solid red;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 5;
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
        }
        .zoom-indicator-circle.hidden { opacity: 0; }

        /* --- STYLES FOR OVERVIEW MAP --- */
        #full-map-overview-container {
            position: relative;
            width: 100%;
            max-width: 1600px;
            margin: 20px auto;
            border: 3px solid #666;
            border-radius: 10px;
            background-color: #3E7BB6; /* Show background color if map fails */
        }
        #full-map-image {
            display: block;
            width: 100%;
            height: auto;
            border-radius: 7px;
        }
        /* Style for the SVG star marker */
        .svg-marker {
            position: absolute;
            width: 18px; /* Control size here */
            height: 18px;
            transform: translate(-50%, -50%);
            cursor: help;
            transition: transform 0.2s ease, filter 0.2s ease;
            filter: drop-shadow(0 0 2px rgba(0,0,0,0.8));
            z-index: 10;
            overflow: visible; /* Important for SVG */
        }
        .svg-marker:hover {
            transform: translate(-50%, -50%) scale(2);
            filter: drop-shadow(0 0 5px #fff);
            z-index: 11;
        }
        #map-error-msg {
            color: white;
            text-align: center;
            padding: 40px;
            font-size: 1.5em;
            font-weight: bold;
            background: #c0392b;
            border-radius: 7px;
        }
    </style>
</head>
<body>

    <h1>Track Data Debug View</h1>
    <div id="debug-container" class="debug-container"></div>

    <hr style="margin: 40px 0; border: none; height: 2px; background-color: #555;">
    <h1>Full Map Overview</h1>

    <div id="full-map-overview-container">
        <!-- Add an error handler to the map image -->
        <img id="full-map-image" src="map/mk_map.webp" alt="Full Map" 
             onerror="this.style.display='none'; document.getElementById('map-error-msg').style.display='block'">
        
        <!-- This message will appear ONLY if the map image fails to load -->
        <div id="map-error-msg" style="display: none;">
            MAP IMAGE FAILED TO LOAD!<br>
            Check the path in your code (`src="map/mk_map.webp"`) and make sure you are running this page from a Live Server.
        </div>
    </div>


    <script>
        const container = document.getElementById('debug-container');

        if (typeof TRACKS_DATA === 'undefined' || typeof PanZoom === 'undefined') {
            // This part seems to be working, so no changes needed.
        } else {
            const MAP_WIDTH = 2004;
            const MAP_HEIGHT = 1086;

            // --- Logic for Individual Debug Items (unchanged, should be working) ---
            const createDebugItem = (track) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'debug-item';
                const leftPercent = (track.mapX / MAP_WIDTH) * 100;
                const topPercent = (track.mapY / MAP_HEIGHT) * 100;
                itemDiv.innerHTML = `
                    <h2>${track.name || 'Unnamed'} <span class="coords">(${track.mapX}, ${track.mapY})</span></h2>
                    <img class="track-photo" src="${track.image}" alt="${track.name}" loading="lazy">
                    <div class="debug-map-wrapper">
                        <div class="debug-map-container">
                            <img class="map-image" src="map/mk_map.webp" alt="Full Map">
                            <div class="zoom-indicator-circle" style="left: ${leftPercent}%; top: ${topPercent}%;"></div>
                            <img class="marker" src="images/star.png" style="left: ${leftPercent}%; top: ${topPercent}%;">
                        </div>
                    </div>
                `;
                container.appendChild(itemDiv);
                const wrapper = itemDiv.querySelector('.debug-map-wrapper');
                const mapContainer = itemDiv.querySelector('.debug-map-container');
                const circle = itemDiv.querySelector('.zoom-indicator-circle');
                if (wrapper && mapContainer) {
                    const pz = new PanZoom(wrapper, mapContainer, { fit: true, maxZoom: 8, onUpdate: () => {
                        if (!pz.initialScale) return;
                        const isClose = pz.scale > pz.initialScale * 3;
                        circle.classList.toggle('hidden', isClose);
                    }});
                    requestAnimationFrame(() => pz.reset());
                }
            };
            TRACKS_DATA.forEach(track => {
                const img = new Image();
                img.onload = () => createDebugItem(track);
                img.onerror = () => console.warn(`Skipping debug item: Image not found at ${track.image}`);
                img.src = track.image;
            });

            // --- REVISED Logic for Full Map Overview ---
            const fullMapContainer = document.getElementById('full-map-overview-container');
            const markerFragment = document.createDocumentFragment();
            const svgNS = "http://www.w3.org/2000/svg"; // SVG Namespace

            TRACKS_DATA.forEach(track => {
                if (track.enabled === false) return;

                const leftPercent = (track.mapX / MAP_WIDTH) * 100;
                const topPercent = (track.mapY / MAP_HEIGHT) * 100;

                // Create an SVG element instead of an IMG
                const markerSvg = document.createElementNS(svgNS, "svg");
                markerSvg.setAttribute("class", "svg-marker");
                markerSvg.setAttribute("viewBox", "0 0 51 48");
                markerSvg.style.left = `${leftPercent}%`;
                markerSvg.style.top = `${topPercent}%`;
                
                // Add a title for the hover tooltip
                const title = document.createElementNS(svgNS, "title");
                title.textContent = `${track.name} (${track.mapX}, ${track.mapY})`;
                markerSvg.appendChild(title);

                // Create the star polygon inside the SVG
                const star = document.createElementNS(svgNS, "polygon");
                star.setAttribute("points", "25,1 31,17 49,17 35,28 40,45 25,35 10,45 15,28 1,17 19,17");
                star.setAttribute("fill", "#FFD700"); // Gold color
                star.setAttribute("stroke", "#C0A000"); // Darker gold border
                star.setAttribute("stroke-width", "2");
                markerSvg.appendChild(star);
                
                markerFragment.appendChild(markerSvg);
            });
            fullMapContainer.appendChild(markerFragment);
        }
    </script>

</body>
</html>